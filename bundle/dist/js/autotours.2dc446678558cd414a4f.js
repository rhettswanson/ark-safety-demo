/*! For license information please see autotours.2dc446678558cd414a4f.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[587],{248:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"ImportAutoGallery"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"importAutoGallery"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[]}]}}],loc:{start:0,end:85}};function a(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var o=e.type;"NamedType"===o.kind&&t.add(o.name.value)}e.selectionSet&&e.selectionSet.selections.forEach(function(e){a(e,t)}),e.variableDefinitions&&e.variableDefinitions.forEach(function(e){a(e,t)}),e.definitions&&e.definitions.forEach(function(e){a(e,t)})}t.loc.source={body:"mutation ImportAutoGallery($modelId: ID!) {\n  importAutoGallery(modelId: $modelId)\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};var o={};function n(e,t){for(var a=0;a<e.definitions.length;a++){var o=e.definitions[a];if(o.name&&o.name.value==t)return o}}t.definitions.forEach(function(e){if(e.name){var t=new Set;a(e,t),o[e.name.value]=t}}),e.exports=t,e.exports.ImportAutoGallery=function(e,t){var a={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(a.loc=e.loc);var i=o[t]||new Set,s=new Set,r=new Set;for(i.forEach(function(e){r.add(e)});r.size>0;){var l=r;r=new Set,l.forEach(function(e){s.has(e)||(s.add(e),(o[e]||new Set).forEach(function(e){r.add(e)}))})}return s.forEach(function(t){var o=n(e,t);o&&a.definitions.push(o)}),a}(t,"ImportAutoGallery")},47067:(e,t,a)=>{"use strict";a.d(t,{P:()=>i});var o=a(12554),n=a(85616);class i extends n.v{constructor(e){super(),this.reel=(0,o.Z)([]),this.modified=new Date,this.mode=e,this.commit()}replace(e){this.atomic(()=>{this.sid=e.sid,this.reel.replace(Array.from(e.reel.values())),this.mode=e.mode,this.modified=e.modified})}}},37e3:(e,t,a)=>{"use strict";a.d(t,{Wu:()=>f});var o=a(10843),n=a(13893),i=a(1333),s=a(25481),r=a(44094),l=a(74381),d=a(72853),c=a(57186),u=a(93877);const h=new o.Ay("mds-reel-element-serializer"),p={[l.ES.FADE_TO_BLACK]:n.fl.FadeToBlack,[l.ES.INSTANT]:n.fl.Instant,[l.ES.INTERPOLATE]:n.fl.Interpolate},m={[l.Zw.LEFT]:i.ND.Left,[l.Zw.RIGHT]:i.ND.Right,[l.Zw.AUTO]:i.ND.Auto};class f{constructor(e){this.sweepTagRequirements=e,this.assetDeserializer=new d.S,this.viewDeserailizer=new c.K}deserialize(e){var t;if(!e||!(null===(t=null==e?void 0:e.asset)||void 0===t?void 0:t.id))return h.debug("Deserialized invalid highlight reel entry from MDS",e),null;const a=e.overrides,o={},n=(null==a?void 0:a.transitionType)?p[null==a?void 0:a.transitionType]:void 0,i=(null==a?void 0:a.panDirection)?m[null==a?void 0:a.panDirection]:void 0,l=null==a?void 0:a.panAngle;(0,r.s)(n)&&(o.transitionType=n),(0,r.s)(i)&&(o.panDirection=i),(0,s.Et)(l)&&(o.panAngle=l);const d=this.assetDeserializer.deserialize(e.asset),c=null==d?void 0:d.metadata.scanTags,f=!this.sweepTagRequirements||!c||c.includes(this.sweepTagRequirements);if(!d||!f)return null;let v;const g=this.viewDeserailizer.getModelViewType(e.sourceView);g!==u.jK.DEFURNISH&&g!==u.jK.DIGIPRO_SESSION||(v=e.sourceView.id),d.sourceViewId=v,g===u.jK.INSIGHTS&&(d.sourceViewId=e.sourceView.id);const w={id:e.asset.id,overrides:o,snapshot:d,sourceViewId:v};return e.title&&(w.title=e.title),e.description&&(w.description=e.description),w}}},13254:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>N});var o=a(65945),n=a(75578),i=a(27947),s=a(22585),r=a(90082),l=a(71687),d=a(28165),c=a(2993),u=a(10843),h=a(73566),p=a(64650),m=a(73094),f=a(25712),v=a(74381),g=a(13893),w=a(47067),D=a(93327),y=a(56388),I=a(24790),T=a(37e3);const S=new u.Ay("get-highlights-for-view"),O=async({client:e,modelId:t,viewType:a})=>{var o,n,i,s,r;const l=[],d=e||(0,y.H)({baseUrl:window.location.origin,server:I.wD})(),c={modelId:t,viewType:a},{data:u}=await d.query(D.GetHighlightReelForView,c),h=new T.Wu(null);return null===(r=null===(s=null===(i=null===(n=null===(o=null==u?void 0:u.model)||void 0===o?void 0:o.view)||void 0===n?void 0:n.model)||void 0===i?void 0:i.activeHighlightReel)||void 0===s?void 0:s.reel)||void 0===r||r.forEach(e=>{const t=h.deserialize(e);t?l.push(t):S.warn("Failed to deserialize reel")}),l};var b=a(248);const A=async({client:e,modelId:t})=>{const a=e||(0,y.H)({baseUrl:window.location.origin,server:I.wD})(),o={modelId:t},{data:n}=await a.query(b.ImportAutoGallery,o);return!!(null==n?void 0:n.importAutoGallery)};var R=a(941);const E=[R.mg,R.GC];class M{constructor({roomBoundData:e,sweepData:t,cameraStartModule:a,snapshotsModule:o,floorsData:n,layersData:i}){this.floorsData=n,this.sweepData=t,this.roomBoundData=e,this.cameraStartModule=a,this.snapshotsModule=o,this.layersData=i}async generateTour(e){var t;const{modelId:a}=e;await A({modelId:a});const o=await O({modelId:a,viewType:"matterport.user.insights"})||[],n={snapshot:{sourceViewId:null===(t=this.layersData.getInsightsView())||void 0===t?void 0:t.id}},i=(e=>{const{cameraStartModule:t,snapshotsModule:a}=e;return(e={})=>{const o=t.data.icon;if(!o)return;let n=a.snapshotsData.get(o);return e.snapshot&&(n=Object.assign(Object.assign({},n),e.snapshot)),{id:n.sid,snapshot:n}}})({cameraStartModule:this.cameraStartModule,snapshotsModule:this.snapshotsModule})(n);i&&o.unshift(i),o.forEach(e=>{if(e.overrides={transitionType:g.fl.Interpolate},!e.snapshot.metadata.scanId&&e.snapshot.metadata.cameraPosition){const t=this.sweepData.getClosestSweep(e.snapshot.metadata.cameraPosition,!0);t&&(e.snapshot.metadata.scanId=t.id)}});const s=new w.P(v.UR.STORY),r=(e=>{const{sweepData:t,roomBoundData:a}=e;return e=>e.reduce((e,o)=>{var n;const{cameraPosition:i,scanId:s}=o.snapshot.metadata;if(!i||!s)return e;const r=null===(n=t.getSweep(s))||void 0===n?void 0:n.floorId;if(!r)return e;const l=a.findRoomIdForPosition(i,r)||null;return e.push(Object.assign(Object.assign({},o),{floorId:r,roomId:l,sweepId:s})),e},[])})({sweepData:this.sweepData,roomBoundData:this.roomBoundData})(o),l=this.postfilter(this.sort(this.prefilter(r)));if(l.length>2){const e=l[0];l.push(Object.assign(Object.assign({},e),{id:(0,f.hA)()}))}return s.reel.replace(l),s}prefilter(e){return(null==e?void 0:e.length)?e.filter(e=>{var t;const{cameraPosition:a}=e.snapshot.metadata,o=e.roomId;if(!a||!o)return!1;const n=this.sweepData.getSweep(e.sweepId);if(!n.isAligned()||!n.enabled)return!1;const i=this.roomBoundData.getRoom(o);return!E.includes(null===(t=i.classifications[0])||void 0===t?void 0:t.id)}):e}postfilter(e){if(!(null==e?void 0:e.length))return e;const t=new Set,a={};let o=null;return e.filter(e=>{var n;const{cameraPosition:i}=e.snapshot.metadata,{roomId:s,sweepId:r}=e;if(!i||!s)return!1;if(t.has(r))return!1;const l=this.sweepData.getSweep(r);return!(o&&o.position.distanceTo(l.position)<2||(null===(n=this.roomBoundData.getRoom(s).classifications[0])||void 0===n?void 0:n.id)===R.Cp&&a[s]>=1||a[s]>=2||(t.add(r),a[s]?a[s]+=1:a[s]=1,o=l,0))})}sort(e){if(!(null==e?void 0:e.length))return e;const t=new Set,a=e.reduce((e,t)=>(e[t.id]=t,e),{}),o=(e=>{const{sweepData:t}=e;return(e,a)=>{if(!e.snapshot.metadata.scanId||a.length<=1)return a[0];const o=t.getSweep(e.snapshot.metadata.scanId);return a.map(e=>{const a=e.snapshot.metadata.scanId,n=t.getSweep(a);return{highlight:e,distance:o.position.distanceToSquared(n.position)}}).sort((e,t)=>e.distance-t.distance)[0].highlight}})({sweepData:this.sweepData}),n=e=>{if(!e.floorId)return;const n=Object.values(a).filter(a=>a.floorId===e.floorId&&!t.has(a)),i=this.sweepData.getSweep(e.sweepId).neighbours,s=n.filter(e=>!!e.sweepId&&i.includes(e.sweepId)),r=s.length?s:n;return o(e,r)},i=e=>{const o=Object.values(a).find(a=>a.floorId===e.floorId&&!t.has(a));if(o)return o;const n=this.floorsData.getFloor(e.floorId),i=(null==n?void 0:n.index)||0,s=this.floorsData.getOrderedValues();for(let e=i;e<s.length;e++){const o=s[e],n=Object.values(a).find(e=>e.floorId===o.id&&!t.has(e));if(n)return n}return Object.values(a).find(e=>!t.has(e))},s=e=>{t.add(e);const r=(e=>{if(!(null==e?void 0:e.roomId))return;const n=Object.values(a).filter(a=>a.roomId===e.roomId&&!t.has(a));return n.length>1?o(e,n):n[0]})(e)||n(e)||i(e);r&&s(r)},r=a[e[0].id];return s(r),[...t]}}class j{async generateTour(e){const{modelId:t}=e;await A({modelId:t});const a=await O({modelId:t,viewType:"matterport.user.insights"}),o=new w.P(v.UR.REEL);return o.reel.replace(a),o}}var _=function(e,t){return function(a,o){t(a,o,e)}};let N=class extends n.n{constructor({data:e},t,{data:a},{data:o},{policyData:n},{data:i},s,r,{data:l},d,{toolsData:c},h,{layersData:p}){super(),this.name="tours-generator",this.templates=new Map,this.applicationData=e,this.cameraStartModule=t,this.floorsData=a,this.modelData=o,this.roomBoundData=i,this.settingsModule=s,this.snapshotsModule=r,this.sweepData=l,this.toursDataModule=h,this.toolsData=c,this.toolAnnouncementModule=d,this.layersData=p,this.enabled=(0,m.W)(n,s.settingsData),u.Ay.for(this).info("AUTO TOURS ENABLED")}async init(e,t){this.engine=t,this.registerTemplates(),this.registerSettings();const a=this.settingsModule.tryGetProperty(d.pH,!1);if(this.applicationData.application===i.lg.SHOWCASE&&a){const e=this.settingsModule.tryGetProperty(d.Ye,d.lB);await this.generateTourFromTemplate(e,{modelId:this.modelData.model.baseModelId}),this.announceAutoGenTourCreated()}else this.enabled&&this.announceAutoGenTourReady()}async generateTourFromTemplate(e,t){if(!this.enabled)throw new Error("Tour generation is not enabled");const a=this.templates.get(e);if(!a)throw new Error(`Template ${e} not found`);this.toolAnnouncementModule.setToolAnnouncementState(h.Q7.HLR_AUTOGEN_TOUR_READY,h.zR.CLOSE);const o=await a.generateTour(t);o.reel.forEach(e=>{if(!e.snapshot.metadata.scanId&&e.snapshot.metadata.cameraPosition){const t=this.sweepData.getClosestSweep(e.snapshot.metadata.cameraPosition,!0);t&&(e.snapshot.metadata.scanId=t.id)}"dollhouse"===e.snapshot.name&&(e.snapshot.metadata.cameraMode=c.N3.Dollhouse,e.snapshot.metadata.scanId=void 0),e.snapshot.name="",e.title="",e.description=""}),this.replaceActiveReel(o)}announceAutoGenTourCreated(){const e=this.engine.subscribe(s.Fj,({application:t})=>{t===i.lg.WORKSHOP&&(this.toolAnnouncementModule.setToolAnnouncementState(h.Q7.HLR_AUTOGEN_TOUR_CREATED,h.zR.OPEN),e.cancel())}),t=this.toolsData.onPropertyChanged("activeToolName",()=>{this.toolAnnouncementModule.setToolAnnouncementState(h.Q7.HLR_AUTOGEN_TOUR_CREATED,h.zR.CLOSE),t.cancel()})}announceAutoGenTourReady(){this.toolAnnouncementModule.setToolAnnouncementState(h.Q7.HLR_AUTOGEN_TOUR_READY,h.zR.OPEN)}replaceActiveReel(e){this.toursDataModule.setHighlightReel(e)}registerTemplates(){this.templates.size>0||(this.templates.set(p.p.SCOUT,new M({cameraStartModule:this.cameraStartModule,floorsData:this.floorsData,roomBoundData:this.roomBoundData,snapshotsModule:this.snapshotsModule,sweepData:this.sweepData,layersData:this.layersData})),this.templates.set(p.p.VISION,new j))}registerSettings(){const e="Tour Generator";this.settingsModule.registerMenuEntry({header:e,urlParam:!0,setting:d.Ye,options:[...this.templates.keys()],initialValue:()=>d.lB}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,setting:d.pH,initialValue:()=>!1})}};N=function(e,t,a,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,a):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,a,o);else for(var r=e.length-1;r>=0;r--)(n=e[r])&&(s=(i<3?n(s):i>3?n(t,a,s):n(t,a))||s);return i>3&&s&&Object.defineProperty(t,a,s),s}([(0,o._q)(),_(0,(0,o.y_)(r.WJ)),_(1,(0,o.y_)(l.di)),_(2,(0,o.y_)(l.HX)),_(3,(0,o.y_)(l.bj)),_(4,(0,o.y_)(l.Uu)),_(5,(0,o.y_)(l.Vu)),_(6,(0,o.y_)(r.ZF)),_(7,(0,o.y_)(l.Pn)),_(8,(0,o.y_)(l.Wh)),_(9,(0,o.y_)(l.uq)),_(10,(0,o.y_)(l.N7)),_(11,(0,o.y_)(l.XQ)),_(12,(0,o.y_)(l.az)),function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata("design:paramtypes",t)}(0,[Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object])],N)}}]);