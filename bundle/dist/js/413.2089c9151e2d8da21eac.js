/*! For license information please see 413.2089c9151e2d8da21eac.js.LICENSE.txt */
"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[413],{44667:(t,e,i)=>{i.d(e,{s:()=>o});var s=i(92475);class o extends s.E{constructor(t,e,i){super(),this.position=t,this.delta=e,this.viewport=i}}},70497:(t,e,i)=>{var s;i.d(e,{X:()=>s}),function(t){t[t.Min=0]="Min",t[t.Standard=1]="Standard",t[t.High=2]="High",t[t.Detail=3]="Detail"}(s||(s={}))},32484:(t,e,i)=>{i.d(e,{yJ:()=>r});var s=i(80112),o=i(47299),n=i(14971);const r={TEXTURE_SETTINGS:o.Ay,TILEDMESH_SETTINGS:s.W,clearRaycastHits:n.Jn}},80112:(t,e,i)=>{i.d(e,{W:()=>r});var s=i(64491),o=i(75778),n=i(70497);const r={urlTemplateToken:"<file>",initialMaxLOD:n.X.Min,nonMeshMaxLOD:n.X.Standard,maxLOD:n.X.High,minLOD:n.X.Min,loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,disableTileUpdates:!1,disposeModel:!1,limitMemoryUsage:(0,s.Fr)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,s.Fr)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,downloadQueueConcurrency:8,parseQueueConcurrency:10,snappingMaxLOD:n.X.Standard,errorTarget:Number((0,o.P3)("errorTarget",(0,s.Fr)()?6:4)),errorMultiplierHiddenFloors:.01,errorMultiplierRaycastOcclusion:.1,smallMeshThreshold:Number((0,o.P3)("smallMeshThreshold",40)),smallMeshErrorMultiplier:Number((0,o.P3)("smallMeshErrorMultiplier",.1))}},83075:(t,e,i)=>{i.d(e,{PO:()=>o,m2:()=>n});var s=i(99276);const o=t=>!!t&&t instanceof s.B,n={hasMeshGroup:t=>"object"==typeof t&&!!t&&"meshGroup"in t,hasMeshSubgroup:t=>"object"==typeof t&&!!t&&"meshSubgroup"in t,isRoomMesh:o,isVisibleRoomMesh:t=>o(t)&&t.raycastEnabled&&t.visible}},14971:(t,e,i)=>{i.d(e,{Jn:()=>c,rt:()=>h});var s=i(68909);const o=i(47299).Ay.sightingMaxAge,n=new s.Color;let r,a=-1;const h=(t,e,i)=>{r||(r=new s.InstancedMesh(new s.SphereGeometry(.005,8,4),new s.MeshBasicMaterial,o),r.frustumCulled=!1,d(r));const h=new s.Matrix4;return({point:s,distance:c})=>{const d=c/i.fovDistanceScale();h.makeScale(d,d,d).setPosition(s),r.setMatrixAt(++a%o,h),r.instanceMatrix.needsUpdate=!0;for(let e=o;e--;)r.setColorAt((a-e+o)%o,n.setHex(t).multiplyScalar(1-e/o));r.instanceColor&&(r.instanceColor.needsUpdate=!0),r.parent||e.scene.add(r)}},c=()=>{var t;r&&(null===(t=r.parent)||void 0===t||t.remove(r),d(r))};function d(t){const e=(new s.Matrix4).makeScale(0,0,0);for(let i=0;i<o;i++)t.setMatrixAt(i,e)}new s.Vector4(1,0,0,1),new s.Vector4(0,1,0,1),new s.Vector4(0,0,1,1),new s.Vector4(1,1,0,1),new s.Vector4(1,0,1,1),new s.Vector4(1,1,1,1),new s.Vector4(0,1,1,1),new s.Vector4(0,0,0,1)},52026:(t,e,i)=>{i.d(e,{GI:()=>d,I9:()=>u,IV:()=>c,Y7:()=>l,vM:()=>h});var s=i(78229),o=i(96659),n=i(65882),r=i(68062),a=i(86866);const h={count:0},c=t=>{const{additionalFilter:e,sweepData:i,direction:n,sourceSweep:r,ignoreSweeps:a,directionFactor:h}=t;if(!i.currentSweepObject)return[];const c=r||i.currentSweepObject,d=[s.AU(c),s.Ol(),s.xg(c),s.jW(c.position,n,h)];for(const t of a)d.push(s.AU(t));const u=[o.oW(c.position,n),o.Io(c.position)];e&&d.push(e);const l=i.getSweepNeighbours(c);return i.sortByScore(d,u,l)},d=t=>{const{sweepData:e,direction:i,viewDirection:r,sourceSweep:a,ignoreSweeps:c,directionFactor:d,additionalFilter:u,meshQuery:l,scorers:p=[],filters:g=[]}=t;if(!e.currentSweepObject)return[];const P=i.clone().normalize(),y=r?r.clone().normalize():void 0,D=a||e.currentSweepObject;g.push(s.AU(D),s.Ol(),s.fm(D.position,n.U.maxDistSameFloor*n.U.maxDistSameFloor),s.Zx());for(const t of c)g.push(s.AU(t));return l&&!D.neighborsEdited||g.push(s.xg(D)),y?g.push(w(D,P,y,null!=d?d:n.U.directionFactor,n.U.viewDirectionFactor)):g.push(s.jW(D.position,P,d)),u&&g.push(u),l&&!D.neighborsEdited&&g.push(T(D,l)),y&&p.push(o.VY(D.position,y,n.U.viewDirectionWeight)),p.push(o.oW(D.position,P,n.U.directionWeight),o.Io(D.position),v(D),m(D.sourceViewId)),h.count=0,e.sortByScore(g,p)},u=(t,e,i,r,a=[],c=[])=>{c.push(s.Ol(),s.Zx()),a.push(o.Io(i.point));const d=t.currentSweepObject;e&&d?(c.push(s.AU(d),s.lp(d.position,n.U.longerTransitionMaxDist),s.xg(d)),a.push(p(t),m(d.sourceViewId))):c.push(s.lp(i.point,n.U.longerTransitionMaxDist)),i.face&&c.push(s.DJ(i.point,i.face.normal));const u=r.floorIdFromObject(i.object);u&&c.push(s.Eo(u));const l=r.mdsRoomIdFromObject(i.object);l&&c.push(g(l)),h.count=0;const w=t.sortByScore(c,a);if(0===w.length){const e=t.getClosestSweep(i.point,!0);w.push({sweep:e,score:0})}return w},l=(t,e,i)=>{const s=(0,r.kf)(t,e);return i&&s.multiply(i),(0,a.V5)(s)},p=t=>{function e(e){return t.containsSweep(e.id)?5:-5}return Object.defineProperty(e,"name",{value:"_preferUnfiltered"}),e},m=t=>{function e(e){return t===e.sourceViewId?1:-1}return Object.defineProperty(e,"name",{value:"_bySameView"}),e},g=t=>{function e(e){return t===e.roomId}return Object.defineProperty(e,"name",{value:"_bySameRoom"}),e},w=(t,e,i,o,n)=>{const r=s.jW(t.position,e,o);Object.defineProperty(r,"name",{value:"_filterByDir"});const a=s.Zz.some(s.Zz.every(r,s.lp(t.position,5)),s.jW(t.position,i,n));return Object.defineProperty(a,"name",{value:"_filterByDirOrViewDir"}),e.dot(i)<.25?r:a},T=(t,e)=>{function i(i){return h.count++,!e.isSegmentOccluded(t.position,i.position)}return Object.defineProperty(i,"name",{value:"_notRaycastNeighbors"}),i},v=t=>{function e(e){return s.xg(t)(e)?1:-1}return Object.defineProperty(e,"name",{value:"_visionNeighbors"}),e}},3680:(t,e,i)=>{i.d(e,{e:()=>h});var s=i(58499),o=i(1333),n=i(81662),r=i(68909),a=i(2993);class h{constructor(t,e,i,r,h,c,d){var u,l;this.options=t,this.settingsData=i,this.cameraPose=r,this.rotate=h,this.stopRotating=c,this.getCurve=d,this.type=o.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.direction=o.ND.Auto,this.degrees=0,this.adjustedPanSpeed=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve();const{path:p,snapshot:m,nextSnapshot:g}=t,w=s.A.getPanValues(this.settingsData,!1,t.panOverrides);this.degrees=w.degrees,this.duration=null!==(u=t.duration)&&void 0!==u?u:w.ms,this.toIndex=e;const T=null!==(l=w.direction)&&void 0!==l?l:o.ND.Auto;let v=w.radiansPerMs;if(void 0!==T&&T!==o.ND.Auto)v*=T;else if(p){const t=this.cameraPose.position.clone().setY(0),e=p.map(t=>t.position),i=this.getCurve(e).curve.getPointAt(.1).setY(0).clone().sub(t).normalize(),s=n.B1.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),o=Math.sign(s.cross(i).y);v=0!==o?v*o:v}else if(g&&m&&(!(0,a.nI)(m.metadata.cameraMode)&&(v=-v),m.metadata.scanId===g.metadata.scanId)){const t=n.B1.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),e=n.B1.FORWARD.clone().applyQuaternion(g.metadata.cameraQuaternion),i=Math.sign(t.cross(e).y);v=0!==i?v*i:v}this.adjustedPanSpeed=v,this.direction=Math.sign(v)}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const{options:t}=this;this.onStopRequested=async()=>{await this.stopRotating()};const e=t.nextSnapshot&&!(0,a.nI)(t.nextSnapshot.metadata.cameraMode),i=this.rotate(this.duration,new r.Vector2(this.adjustedPanSpeed,0),!e);return this.currentTransitionPromise=i.then(()=>{this.currentTransitionPromise=null,this.stopped=Date.now()}),this.started=Date.now(),this.stopped=-1,this}}},58499:(t,e,i)=>{i.d(e,{A:()=>_});var s=i(53172),o=i(86866),n=i(60152),r=i(88664),a=i(56208),h=i(90160),c=i(1333);class d{constructor(t=-1){this.active=!1,this.type=c.gX.Nop,this.promise=Promise.resolve(),this.stop=()=>Promise.resolve(),this.duration=0,this.started=-1,this.stopped=-1,this.toIndex=t}start(){return this}}var u=i(48539);class l{constructor(t,e){this.type=c.gX.Delay,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.cancelDelay=()=>null,this.duration=t,this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(this.cancelDelay(),this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const t=(0,u.op)(this.duration);return this.cancelDelay=()=>{t.resolveEarly()},this.currentTransitionPromise=t.promise.then(()=>this.stop()),this.started=Date.now(),this.stopped=-1,this}}class p{constructor(t,e,i,s){this.zoom=i,this.stopZooming=s,this.type=c.gX.Zoom,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.duration=t.duration,this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");return this.currentTransitionPromise=this.zoom(this.duration,-5).then(()=>{this.currentTransitionPromise=null,this.stopped=Date.now()}),this.started=Date.now(),this.stopped=-1,this.onStopRequested=async()=>{await this.stopZooming()},this}}var m=i(68909),g=i(81662),w=i(33007);class T{constructor(t,e,i,s,o){var n;this.options=t,this.settingsData=i,this.rotate=s,this.stopRotating=o,this.type=c.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e,this.duration=null!==(n=t.duration)&&void 0!==n?n:_.getPanValues(this.settingsData,!1,t.panOverrides).ms}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const{options:t}=this;if(!t.snapshot||!t.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this.started=Date.now(),this.stopped=Date.now(),this;const{deferred:e}=this.build(t.snapshot,t.nextSnapshot,t.panOverrides);return this.currentTransitionPromise=e.then(()=>{this.currentTransitionPromise=null,this.stopped=Date.now()}),this.started=Date.now(),this.stopped=-1,this}build(t,e,i){const s=_.getPanValues(this.settingsData,!1,i);let o=s.direction;return void 0!==o&&o!==c.ND.Auto||(o=T.getAutoPanDirection(t,e)),this.onStopRequested=async()=>{await this.stopRotating()},{deferred:this.rotate(this.duration,new m.Vector2(o*s.radiansPerMs,0))}}static getAutoPanDirection(t,e){let i=c.ND.Right;if(t&&t.metadata.scanId&&t.metadata.cameraQuaternion&&t.metadata.cameraPosition&&e&&e.metadata.scanId&&e.metadata.cameraPosition&&e.metadata.cameraQuaternion){const s=g.B1.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),o=e.metadata.cameraPosition,n=t.metadata.cameraPosition;let r=o.clone().sub(n).normalize();r.lengthSq()<w.A.epsilon&&(r=g.B1.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion)),s.cross(r).y>0&&(i=c.ND.Left)}return i}}var v=i(79769),P=i(13893),y=i(94814),D=i(31093),f=i(48734);const S=.001,I=(t,e,i,s)=>{const o=Math.max(.75,Math.min(t.distanceTo(e),5)),n=o*(1/s)*1e3;let r=n;const a=i/n;a>S&&(r+=r*((a-S)/S));const h=Math.abs(t.clone().setX(0).setZ(0).distanceTo(e.clone().setX(0).setZ(0))/Math.max(o,1));return h>.1&&(r*=.9+.75*h),r};class M extends c.Tz{constructor(t,e,i,s,o,n,r,a){super(),this.options=t,this.settingsData=i,this.cameraPose=s,this.moveToSweep=o,this.updateTransitionSpeed=n,this.setRestrictedSweeps=r,this.generators=a,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentGenerator=null,this.currentTransitionPromise=null,this.type=c.gX.Move,this.toIndex=e,this.sweeps=t.path.slice(0,2)}get active(){return null!==this.currentTransitionPromise||null!==this.currentGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now()),this.currentGenerator&&(this.generators.stopGenerator(this.currentGenerator),this.currentGenerator=null)}calculateCurve(){const{sweeps:[{position:t},{position:e}]}=this,i=t.distanceTo(e);return{curve:new m.LineCurve3(t,e),totalLength:i,normalSourceDistances:[0,1],sourceDistances:[0,i]}}start(){if(this.active)throw Error("Transition already active");const{options:t}=this,{generator:e,deferred:i}=this.build(t.path,t.orientations);return this.generators.startGenerator(e),this.currentGenerator=e,this.currentTransitionPromise=i.nativePromise(),this.started=Date.now(),this.stopped=-1,this}build(t,e){const i=new D.i,s=this;let n=!1;return this.onStopRequested=async()=>{n=!0,await this.updateTransitionSpeed(v.FAST_FORWARD_FACTOR)},{generator:function*(){let r=1;for(;r<t.length&&!n;){const i=r-1,n=t[r],a=n.position,h=t[i],c=e[r],d=(0,o.HN)(s.cameraPose.rotation,c),u=_.getTransitionSpeed(s.settingsData),l=I(h.position,a,d,u),p={transitionType:P.fl.Interpolate,sweepId:n.id,rotation:c,transitionTime:l,easing:y.p9};s.duration=l,s.setRestrictedSweeps(t,i);const m=s.moveToSweep(p);yield new f.sv(m.nativePromise()),r++}s.setRestrictedSweeps(null),i.resolve(),s.currentTransitionPromise=null,s.stop()},deferred:i}}}var C=i(39209);const b=new(i(10843).Ay)("tours");class x extends c.Tz{constructor(t,e,i,s,n,r,a,h,d,u,l){super(),this.options=t,this.cameraPose=s,this.cameraTransition=n,this.sweepTransition=r,this.sweepControl=a,this.cameraControl=h,this.generators=d,this.setRestrictedSweeps=u,this.getCurve=l,this.type=c.gX.Path,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.speed=0,this.currentTransitionGenerator=null,this.currentTransitionPromise=null,this.canceling=!1,this.buildTransition=(t,e)=>{const i=this,s=new D.i,n=this.calculateCurve(),r=y.p9,a=y.rn,h=y.dV;return i.cameraControl.beginExternalTransition(),{generator:function*(){s.notify(0);const c=new m.Vector3,d=new m.Quaternion;let u=0,l=0,p=0,g=1,w=t[g].id;yield new f.sv(i.sweepControl.activateSweepUnsafe({sweepId:w}).then(()=>{i.sweepControl.beginSweepTransition({sweepId:w,transitionTime:i.duration,internalProgress:!1})})),t.length>2&&i.sweepControl.activateSweepUnsafe({sweepId:t[2].id});let T=i.cameraPose.rotation.clone();for(;u<i.duration&&!i.canceling;){const m=u/i.duration;p>0&&(T=e[p].clone());const v=e[g],P=n.normalSourceDistances[p],y=n.normalSourceDistances[g],D=t[g];if(l=(0,o.OF)(m,P,y,0,1),l<=1){const t=h(l,0,1,1);i.sweepTransition.progress.modifyAnimation(t,1,0);const e=a(l,0,1,1);d.copy(T).slerp(v,e)}m<1&&c.copy(n.curve.getPointAt(r(m,0,1,1))),i.cameraControl.updateCameraPosition(c),i.cameraControl.updateCameraRotation(d),m>=y&&(i.sweepControl.endSweepTransition({sweepId:D.id}),p++,g++,w=t[p+1].id,yield new f.sv(i.sweepControl.activateSweepUnsafe({sweepId:w}).then(()=>{i.sweepControl.beginSweepTransition({sweepId:w,transitionTime:i.duration,internalProgress:!1})})),t.length>p+2&&i.sweepControl.activateSweepUnsafe({sweepId:t[p+2].id})),s.notify(m),u=Date.now()-i.cameraTransition.startTime,yield new f.oN}if(i.cameraControl.endExternalTransition(),i.canceling){i.canceling=!1;const e=t[g].position,s=I(i.cameraPose.position,e,0,i.speed),n=i.cameraControl.moveTo({transitionTime:s/v.FAST_FORWARD_FACTOR,transitionType:P.fl.Interpolate,pose:{position:e}});n.progress(t=>{const e=(0,o.OF)(t,0,1,l,1);i.sweepTransition.progress.modifyAnimation(e,1,0)}),yield new f.sv(n.nativePromise())}i.sweepControl.endSweepTransition({sweepId:w}),s.notify(1),s.resolve()},deferred:s}},this.toIndex=e,this.sweeps=t.path,this.speed=_.getTransitionSpeed(i),this.duration=((t,e,i)=>{let s=0;for(let n=0;n<t.length-1;n++){const r=(0,o.HN)(e[n],e[n+1]);s+=I(t[n].position,t[n+1].position,r,i)}return s})(t.path,t.orientations,this.speed),b.debug(`path duration: ${this.duration.toFixed(0)}ms, at speed: ${this.speed}m/s`)}get active(){return null!==this.currentTransitionPromise||null!==this.currentTransitionGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.canceling=!0,this.currentTransitionPromise&&(await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now()),this.currentTransitionGenerator&&(this.generators.stopGenerator(this.currentTransitionGenerator),this.currentTransitionGenerator=null)}start(){const{options:t}=this;if(b.debug(`starting smooth transition with ${t.path.length-1} stops`),this.active)throw Error("Transition already active");this.canceling=!1;const{generator:e,deferred:i}=this.buildTransition(t.path,t.orientations);return this.generators.startGenerator(e),this.currentTransitionGenerator=e,this.currentTransitionPromise=i.nativePromise().then(()=>{this.currentTransitionPromise=null,this.currentTransitionGenerator=null,this.stopped=Date.now()}),this.started=Date.now(),this.stopped=-1,this}calculateCurve(){const t=this.options.path;if(t.length<=2)throw b.debug(`invalid path: ${t}`),new Error("smooth path requires more than 2 stops");this.setRestrictedSweeps(t);const e=t.map(t=>t.position),i=this.getCurve(e);return this.setRestrictedSweeps(null),i}}var R=i(2993);class F{constructor(t,e,i,s,o,n,r,a,h,d){this.options=t,this.settingsData=i,this.cameraPose=s,this.viewmodeData=o,this.cameraControl=n,this.sweepControl=r,this.switchToMode=a,this.setRestrictedSweeps=h,this.generators=d,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.type=c.gX.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const t=this.options;if(!t.snapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:e}=this.build(t.snapshot,t.currentSweep,t.transitionType);return this.currentTransitionPromise=e.then(()=>{this.currentTransitionPromise=null,this.stopped=Date.now()}),this.started=Date.now(),this.stopped=-1,this}build(t,e,i){var s,n,r;let a=Promise.resolve();const h=t.metadata.cameraMode,c=t.metadata.cameraQuaternion;let d,u;if(t.metadata.scanId){const e=this.sweepControl.getSweepOnView(t.metadata.scanId,null!==(s=t.sourceViewId)&&void 0!==s?s:null);d=null==e?void 0:e.id,u=null==e?void 0:e.platformId}const l=this.cameraPose.rotation,p=(0,o.HN)(l,c),m=t.metadata.cameraPosition,g=!t.is360,w={position:m,rotation:c,sweepID:d,zoom:t.metadata.orthoZoom};let T=_.getOtherModeTransitionTime(this.settingsData,p,i);const v=this.viewmodeData.isDollhouse()&&!this.cameraPose.isPitchFactorOrtho,y=this.viewmodeData.isFloorplan()||this.cameraPose.isPitchFactorOrtho,D=h===R.N3.Floorplan;if(h===R.N3.Dollhouse&&!v||D&&!y||h!==this.viewmodeData.currentMode)a=this.switchToMode(h,i,w,T);else if(d&&this.viewmodeData.isInside()){if(d){const s=e&&(null===(n=this.sweepControl.data.currentSweepObject)||void 0===n?void 0:n.platformId)===u,o=((null===(r=this.sweepControl.data.currentSweepObject)||void 0===r?void 0:r.sourceViewId)||null)!==(t.sourceViewId||null),h=!e||d!==e;s?(T=_.getSamePanoTransitionTime(this.settingsData,p),a=o?this.standardSweepMovePromise({rotation:w.rotation,targetSweepId:d,transitionTime:T,transitionType:P.fl.Interpolate,viewId:t.sourceViewId}):this.standardTransitionSameSweepRotationPromise(w.rotation,d,p,T,t.sourceViewId)):h&&(T=_.getTransitionTime(this.settingsData),a=t.is360?this.standardSweepMovePromise({rotation:w.rotation,targetSweepId:d,transitionTime:T,transitionType:i,viewId:t.sourceViewId}):this.standardTransitionSweepMovePromise(w,d,g,T))}}else a=this.cameraControl.moveTo({transitionType:i,pose:w,transitionTime:T}).nativePromise();return this.duration=null!=T?T:0,{deferred:a}}standardTransitionSameSweepRotationPromise(t,e,i,s,o){var n;return this.setRestrictedSweeps(null),(null===(n=this.sweepControl.data.currentSweepObject)||void 0===n?void 0:n.id)!==e?this.sweepControl.moveToSweep({sweepId:e,viewId:null!=o?o:null,transitionTime:s,transitionType:P.fl.Interpolate,rotation:t}).nativePromise():i<.01?Promise.resolve():this.cameraControl.moveTo({transitionType:P.fl.Interpolate,pose:{rotation:t},transitionTime:s}).nativePromise()}standardSweepMovePromise({rotation:t,targetSweepId:e,transitionTime:i,transitionType:s,viewId:o}){return this.sweepControl.moveToSweep({rotation:t,sweepId:e,transitionTime:i,transitionType:s,viewId:null!=o?o:null}).nativePromise()}standardTransitionSweepMovePromise(t,e,i,s){if(!t.position)throw Error("Push transition requires a position");const o=t.position.clone().sub(this.cameraPose.position).normalize(),n=this.cameraPose.position.clone().add(o.multiplyScalar(.15)),r=new D.i;this.setRestrictedSweeps(null);const a=this;return this.generators.startGenerator(function*(){yield new f.sv(a.sweepControl.activateSweepUnsafe({sweepId:e}));const o=new m.Vector3,h=a.cameraPose.position.clone(),c=Date.now();let d,u=0,l=!1,p=!1;for(;u<s;){const r=(0,y.Do)(u,0,u/s,s);i&&a.cameraControl.updateCameraPosition(o.copy(h).lerp(n,r)),r>=.3&&!p&&(d=a.cameraControl.moveTo({transitionType:P.fl.FadeToBlack,pose:t,transitionTime:s,blackoutTime:.5*s}).progress(t=>{t>=.5&&!l&&(a.sweepControl.instantSweepTransition(e),l=!0)}),p=!0),yield new f.oN,u=Date.now()-c}d&&(yield new f.sv(d.nativePromise())),r.resolve()}),r.nativePromise()}}class V{constructor(t,e,i,s,o,n){this.options=t,this.moveToSweep=i,this.viewmodeData=s,this.cameraControl=o,this.switchToMode=n,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.type=c.gX.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const{options:t}=this;if(!t.snapshot)return this.currentTransitionPromise=Promise.resolve(),this.started=Date.now(),this.stopped=Date.now(),this;const{deferred:e}=this.build(t.snapshot,t.currentSweep);return this.currentTransitionPromise=e.then(()=>{this.currentTransitionPromise=null,this.stopped=Date.now()}),this.started=Date.now(),this.stopped=-1,this}build(t,e){let i=Promise.resolve();const s=t.metadata.cameraMode,o=t.metadata.cameraQuaternion,n=t.metadata.scanId,r={position:t.metadata.cameraPosition,rotation:o,sweepID:n,zoom:t.metadata.orthoZoom},a=s!==this.viewmodeData.currentMode,h=!!n&&this.viewmodeData.isInside();if(a)i=this.switchToMode(s,P.fl.Instant,r);else if(h){const t={transitionType:P.fl.Instant,sweepId:n,rotation:o};i=this.moveToSweep(t).nativePromise()}else i=this.cameraControl.moveTo({transitionType:P.fl.Instant,pose:r}).nativePromise();return{deferred:i}}}var O=i(72773),A=i(23272);class N{constructor(t,e,i,s){this.targetSnapshot=t,this.issueCommand=i,this.currentFloorId=s,this.type=c.gX.FloorChange,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=O.t$,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");let t=Promise.resolve();const e=this.targetSnapshot.metadata.floorId,i=e!==this.currentFloorId(),s=this.targetSnapshot.metadata.cameraMode;return!(0,R.nI)(s)&&s!==R.N3.Outdoor&&i&&(t=this.issueCommand(new A.i1(e,!0,this.duration))),this.currentTransitionPromise=t.then(()=>{this.currentTransitionPromise=null,this.stopped=Date.now()}),this.started=Date.now(),this.stopped=-1,this}}class E{constructor(t,e,i,s,o){var n;this.options=t,this.settingsData=i,this.rotate=s,this.stopRotating=o,this.type=c.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.toIndex=e,this.duration=null!==(n=t.duration)&&void 0!==n?n:_.getPanValues(this.settingsData,!0,t.panOverrides).ms}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(){if(this.active)throw Error("Transition already active");const{options:t}=this;if(!t.snapshot||!t.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:e}=this.build(t.snapshot,t.nextSnapshot,t.panOverrides);return this.currentTransitionPromise=e.then(()=>{this.currentTransitionPromise=null,this.stopped=Date.now()}),this.started=Date.now(),this.stopped=-1,this}build(t,e,i){const s=_.getPanValues(this.settingsData,!0,i);let o=-1*s.radiansPerMs;const n=s.direction;if(void 0!==n&&n!==c.ND.Auto)o*=n;else if(t&&t.metadata.cameraQuaternion&&e&&e.metadata.cameraQuaternion){const i=g.B1.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),s=g.B1.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion),n=Math.sign(i.cross(s).y);o=0!==n?o*n:o}return this.onStopRequested=async()=>{await this.stopRotating()},{deferred:this.rotate(this.duration,new m.Vector2(o,0))}}}var B=i(3680);const G={sharpTurnDotThreshold:.65,directionWeightFactorStd:.75,directionWeightFactorSharp:.2,positionalWeightFactorStd:.4,positionalWeightFactorSharp:.2,finalWalkingNodeDirectionWeight:5,lookAheadNodes:3};class W{constructor(t=G){this.settings=t}getOrientationsForPath(t,e){const i=[];for(let s=0;s<t.length;s++){const o=new m.Vector3;this.getLookVectorsForPathNode(t,s,e,o);const n=(new m.Matrix4).lookAt(t[s],o,g.B1.UP);i[s]=(new m.Quaternion).setFromRotationMatrix(n)}return i.push(e),i}getLookVectorsForPathNode(t,e,i,s){const o=new m.Vector3,n=new m.Vector3,r=new m.Vector3,a=new m.Vector3,h=t.length;if(e>=h)return!1;let c=1,d=1;const u=new m.Vector3;let l;for(let s=e;s<e+this.settings.lookAheadNodes&&s<h;s++){if(l=t[s],this.getOrientationForPathNode(t,s,i,r),s===e&&o.copy(r),s>e){const t=o.dot(r)<this.settings.sharpTurnDotThreshold;c*=t?this.settings.directionWeightFactorSharp:this.settings.directionWeightFactorStd,d*=t?this.settings.positionalWeightFactorSharp:this.settings.positionalWeightFactorStd}s===h-1&&(c=this.settings.finalWalkingNodeDirectionWeight,d=1),u.copy(r),r.multiplyScalar(c),n.add(r),a.lerp(l,d)}return n.normalize(),s.copy(a),s.add(n),!0}getOrientationForPathNode(t,e,i,s){if(e>=t.length)return!1;if(e===t.length-1)s.copy(g.B1.FORWARD).applyQuaternion(i);else{const i=t[e],o=t[e+1];s.copy(o).sub(i)}return s.normalize(),!0}}var k=i(71687);class j{constructor(t,e,i,s){this.sweepModule=t,this.pathModule=e,this.tourData=i,this.viewmodeData=s,this.getValidWalkingPath=t=>{var e,i;const s=null===(e=this.sweepModule.data.currentSweepObject)||void 0===e?void 0:e.platformId;let o;t.metadata.scanId&&(o=null===(i=this.sweepModule.data.getSweep(t.metadata.scanId))||void 0===i?void 0:i.platformId);let r=null;const a=this.tourData.getTourCurrentSnapshotSid();if(a){const t=this.tourData.getTourEntry(a);r=(null==t?void 0:t.snapshot)||null}if(!r||this.viewmodeData.currentMode!==R.N3.Panorama||!s||!o||s===o||r.is360||t.is360)return null;const h=this.pathModule.findShortestPath(s,o,n.W0.maxSweepDistance,n.W0.maxDistanceBeforeAddingSweeps,n.W0.minSweepDistance,n.W0.maxSidestepDistance,n.W0.pathRadius,n.W0.maxTotalSteps)||[];if(0===h.length)return null;if(t.sourceViewId||r.sourceViewId){const e=[];for(const i of h)0===e.length?e.push(this.sweepModule.getSweepOnView(i.platformId,r.sourceViewId)):e.push(this.sweepModule.getSweepOnView(i.platformId,t.sourceViewId));return e}return h}}}var Q=i(44481),L=i(35447);class _{constructor(t,e,i,s,o,n){this.engine=t,this.tourData=e,this.sweepModule=i,this.cameraData=s,this.settingsData=o,this.viewmodeData=n,this.init=async()=>{this.sweepData=this.sweepModule.data,this.cameraPoseController=await this.engine.getModuleBySymbol(k.jh),this.pathModule=await this.engine.getModuleBySymbol(k.Np),this.floorsViewData=await this.engine.market.waitForData(C.X),this.toursViewData=await this.engine.market.waitForData(Q.F),this.commonControlsModule=await this.engine.getModuleBySymbol(k.X7),this.viewmodeModule=await this.engine.getModuleBySymbol(k.SD),this.pathOrientHelper=new W,this.setRestrictedSweeps=this.pathModule.setRestrictedSweeps.bind(this.pathModule),this.getCurveForPath=this.pathModule.getCurveForPath.bind(this.pathModule),this.moveToSweep=this.sweepModule.moveToSweep.bind(this.sweepModule),this.updateTransitionSpeed=this.cameraPoseController.updateTransitionSpeed.bind(this.cameraPoseController),this.switchToMode=this.viewmodeModule.switchToMode.bind(this.viewmodeModule),this.startRotateTransition=this.commonControlsModule.startRotateTransition.bind(this.commonControlsModule),this.stopCamera=this.commonControlsModule.stop.bind(this.commonControlsModule),this.startZoomTransition=this.commonControlsModule.startZoomTransition.bind(this.commonControlsModule),this.issueCommand=this.engine.commandBinder.issueCommand.bind(this.engine.commandBinder),this.walkingPath=new j(this.sweepModule,this.pathModule,this.tourData,this.viewmodeData)}}static isDelayTransition(t,e,i){return!(0,n.ht)(t)||e!==c._y.Zoom&&0===_.getPanDegrees(t,i.panAngle)}getBurnsStyleForSnapshot(t){const{tourData:e}=this,i=e.getTourEntrySidFromIndex(t),s=e.getTourEntry(i),o=e.getHighlightsCount();if(!s||!s.snapshot)return c._y.None;if(t===o-1&&this.isStaticFinalStop(t))return this.toursViewData.getTourStoryMode()?c._y.Delay:c._y.None;const n=s.snapshot.metadata.cameraMode,r=n===R.N3.Dollhouse?c._y.PanDollhouse:n===R.N3.Floorplan?c._y.Zoom:c._y.Pan;return _.isDelayTransition(this.settingsData,r,s.overrides||{})?c._y.Delay:r}isStaticFinalStop(t){if(t<this.tourData.getHighlightsCount()-1)return!1;const{overrides:e}=this.tourData.getReel().reel.get(t),i=_.getPanDirection(this.settingsData,null==e?void 0:e.panDirection),s=_.getPanDegrees(this.settingsData,null==e?void 0:e.panAngle),o=this.tourData.getActiveReelTourMode(),n=(0,L.Kl)(this.settingsData,o);return 0===s||!n&&i===c.ND.Auto}static getPanDegrees(t,e){let i;return i=(0,n.ht)(t)?-1!==t.getOverrideParam(n.I5,-1)?(0,n.H1)(t):void 0!==e?e:t.tryGetProperty(a.Q$.PanAngle,n.V4):0,Math.max(i,0)}static getPanDirection(t,e){return void 0!==e?e:t.tryGetProperty(a.Q$.PanDirection,r.ek)}static getDelayDuration(t){return-1!==t.getOverrideParam(n.R8,-1)||0===t.getOverrideParam(n.Yh,-1)?(0,n.Lh)(t):n.DE}static getZoomDuration(t){return-1!==t.getOverrideParam(n.R8,-1)?(0,n.Lh)(t):t.tryGetProperty(a.Q$.ZoomDuration,n.cS)}static getPanRadiansPerMs(t,e,i,s){if(void 0===s&&-1!==t.getOverrideParam(n.R8,-1)&&(s=(0,n.Lh)(t)),void 0!==s)return s>0?i/s:0;const o=e?t.tryGetProperty(a.Q$.DollhousePanSpeed,n.lo):t.tryGetProperty(a.Q$.PanSpeed,n.BU);return(0,h.rX)(o)}static getPanValues(t,e,{panDirection:i,panAngle:o,panDuration:r}={}){const a=_.getPanDirection(t,i),h=_.getPanDegrees(t,o),c=(0,s.pu)(h),d=_.getPanRadiansPerMs(t,e,c,r);let u=d>0?c/d:0;return e&&void 0===o&&(u=(0,n.Lh)(t)),{degrees:h,radiansPerMs:d,ms:u,direction:a}}static getTransitionSpeed(t){if(-1!==t.getOverrideParam("wts",-1))return t.tryGetProperty(n._V,n.aS);const e=t.tryGetProperty(a.Q$.TransitionSpeed,n.Dj);return(0,h.f7)(e/1e3)}static getTransitionTime(t){const e=t.tryGetProperty(a.Q$.TransitionTime,n.VD);return Math.min(Math.max(n.K1,e),n.s$)}static getOtherModeTransitionTime(t,e,i){if(i===P.fl.FadeToBlack)return _.getTransitionTime(t)+n.IT;let o=n.BS,r=n.uO;if(-1===t.getOverrideParam("wts",-1)){const e=1e3*_.getTransitionSpeed(t);o=Math.sqrt(2*(e-n.g$))+45,e!==n.Dj&&(r=n.Jb)}const a=1e3*e/(s.fy*o);return Math.max(a,r)}static getSamePanoTransitionTime(t,e){const i=t.tryGetProperty(a.Q$.PanSpeed,n.BU);if(i===n.BU)return Math.max(1e3*e/(s.fy*n.Md),n.fi);{const t=(0,o.m9)(i,n.Ih,n.at,n.mf,n.QR),s=(0,h.rX)(t);return s>0?e/s:0}}getFloorTransition(t){var e;const i=this.tourData.getTourEntrySidFromIndex(t),s=null===(e=this.tourData.getTourEntry(i))||void 0===e?void 0:e.snapshot;return s?new N(s,t,this.issueCommand,()=>this.floorsViewData.currentFloorId):new d(t)}getMainTransition(t,e){var i;const s=this.tourData.getTourEntrySidFromIndex(t),n=null===(i=this.tourData.getTourEntry(s))||void 0===i?void 0:i.snapshot;if(!n)return new d(t);let r=null;if(e===P.fl.Interpolate){const e=n.metadata.cameraQuaternion,i=this.walkingPath.getValidWalkingPath(n);if(i){const s=i.map(t=>t.position),n=this.pathOrientHelper.getOrientationsForPath(s,(0,o.V5)(e));r=i.length>2?new x({path:i,orientations:n},t,this.settingsData,this.cameraData.pose,this.cameraData.transition,this.sweepData.transition,this.sweepModule,this.cameraPoseController,this.engine,this.setRestrictedSweeps,this.getCurveForPath):new M({path:i,orientations:n},t,this.settingsData,this.cameraData.pose,this.moveToSweep,this.updateTransitionSpeed,this.setRestrictedSweeps,this.engine)}}else if(e===P.fl.Instant){const e=this.sweepData.currentSweep;r=new V({snapshot:n,currentSweep:e},t,this.moveToSweep,this.viewmodeData,this.cameraPoseController,this.switchToMode)}if(!r){const i=this.sweepData.currentSweep;r=new F({snapshot:n,currentSweep:i,transitionType:e},t,this.settingsData,this.cameraData.pose,this.viewmodeData,this.cameraPoseController,this.sweepModule,this.switchToMode,this.setRestrictedSweeps,this.engine)}return r}getBurnsTransition(t,e=this.getBurnsStyleForSnapshot(t),i){var s,o;const n=this.tourData.getTourEntrySidFromIndex(t),r=(t+1)%this.tourData.getHighlightsCount(),a=this.tourData.getTourEntrySidFromIndex(r),h=this.tourData.getTourEntry(n);if(!h)return new d(t);const u=h.snapshot,m={};h.overrides&&(m.panDirection=h.overrides.panDirection,m.panAngle=h.overrides.panAngle,m.panDuration=h.overrides.panDuration);const g=(null===(s=this.tourData.getTourEntry(a))||void 0===s?void 0:s.snapshot)||null;let w=new d(t);switch(e){case c._y.Pan:if(g){const e=this.walkingPath.getValidWalkingPath(g);w=new B.e({path:e,snapshot:u,nextSnapshot:g,panOverrides:m,duration:i},t,this.settingsData,this.cameraData.pose,this.startRotateTransition,this.stopCamera,this.getCurveForPath)}w.type===c.gX.Nop&&(w=new T({snapshot:h.snapshot,nextSnapshot:g,panOverrides:m,duration:i},t,this.settingsData,this.startRotateTransition,this.stopCamera));break;case c._y.PanDollhouse:w=new E({snapshot:u,nextSnapshot:g,panOverrides:m,duration:i},t,this.settingsData,this.startRotateTransition,this.stopCamera);break;case c._y.Zoom:w=new p({duration:null!==(o=null!=i?i:m.panDuration)&&void 0!==o?o:_.getZoomDuration(this.settingsData)},t,this.startZoomTransition,this.stopCamera);break;case c._y.Delay:w=new l(null!=i?i:_.getDelayDuration(this.settingsData),t);break;case c._y.None:w=new d(t);break;default:throw Error("unhandled TourBurnsStyle")}return w}}},79769:(t,e,i)=>{i.r(e),i.d(e,{FAST_FORWARD_FACTOR:()=>x,default:()=>R});var s=i(48734),o=i(60152),n=i(75578),r=i(2993),a=i(96425),h=i(21875),c=i(44481),d=i(99583),u=i(13893),l=i(22937),p=i(78079),m=i(44667),g=i(27947),w=i(22585),T=i(25316),v=i(20599),P=i(58499),y=i(1333),D=i(88664),f=i(8333),S=i(68930),I=i(71687),M=i(35447),C=i(47737),b=i(10843);const x=5;class R extends n.n{constructor(){super(...arguments),this.name="tours-controls",this.canChangeTourLocation=()=>{const t=this.data.getTourState(),e=this.data.isTourTransitionActive(),i=this.cameraData.canTransition();return t===a.Ci.Inactive&&!e&&!(this.viewmodeData.transition&&this.viewmodeData.transition.active)&&i}}async init(t,e){this.engine=e,[this.cameraData,this.viewmodeData,this.settingsData,this.data,this.toursViewData]=await Promise.all([e.market.waitForData(v.M),e.market.waitForData(d.X),e.market.waitForData(T.o),e.market.waitForData(h.R),e.market.waitForData(c.F)]);const i=await e.market.waitForData(C.P),s=await e.getModuleBySymbol(I.Wh);e.getModuleBySymbol(I.mL).then(t=>{t.registerHandler(p.CD,()=>{this.handleTourInputInterrupt()}),t.registerHandler(m.s,()=>{this.handleTourInputInterrupt()})}),this.transitionFactory=new P.A(e,this.data,s,this.cameraData,this.settingsData,this.viewmodeData),await this.transitionFactory.init(),this.setupAutoPlay(e),this.bindings.push(i.onPropertyChanged("currentViewId",()=>this.stopTour()))}handleTourInputInterrupt(){this.data.getTourState()!==a.Ci.Inactive&&this.stopTour()}canTourProceed(t,e,i){const s=this.data.getHighlightsCount();if(0===s||0===i||this.data.getTourState()!==a.Ci.Inactive)return!1;if(void 0!==e){if(e<-1)return!1;if(!0!==t&&e>s-1)return!1}return!0}shouldTourContinue(t,e,i,s){return void 0!==s?i<s:e<t-1}startTour({index:t,steps:e,loop:i}={}){if(!this.canChangeTourLocation())throw new S.r("Cannot start tour at this time, another transition is active");const o=void 0!==i?i:this.data.isLooping();if(!this.canTourProceed(o,t,e))return;this.data.setLooping(o);const n=this.data.getActiveReelTourMode(),r=(0,M.Kl)(this.settingsData,n),h=this.data.getTourCurrentSnapshotIndex(),c=this.data.getHighlightsCount(),d=this.data.transition,u=h===c-1&&(y.h9.includes(d.type)||!r)&&d.toIndex===c-1&&d.stopped-d.started>=d.duration;let p,m=0;p=void 0!==t?t-1:u?-1:Math.max(h-1,-1);const g=this.settingsData.tryGetProperty(f.Oe,null);this.settingsData.setProperty(f.Oe,null);const w=this;this.tourGenerator=function*(){for(;w.shouldTourContinue(c,p,m,e);){const t=p+1,e=w.composeTourTransition(t);yield new s.sv(e),p=t,p===c-1&&o&&(p=-1),m++}w.stopTour(),w.settingsData.setProperty(f.Oe,g)},this.engine.startGenerator(this.tourGenerator),this.data.setTourState(a.Ci.Active),this.data.tourEnded=!1,this.data.tourWillResume=!1,this.data.tourPlaying=!0,this.data.commit(),this.engine.broadcast(new l.zM)}async composeTourTransition(t,e,i){var s;const n=this.data.getTourEntrySidFromIndex(t),h=this.data.getTourEntry(n);if(!h||!h.snapshot)throw Error(`Highlight not found for reel index ${t}`);const c=this.data.getTourCurrentSnapshotSid()===n,d=this.cameraData.transition.startTime>this.data.transition.stopped;let p=0;const m=this.data.transition.duration;if(c){const{started:t,stopped:e}=this.data.transition;p=(e-t)/m||0,p=Math.min(1,p)}if(d||!c){let e=this.settingsData.tryGetProperty(D.zk,u.fl.Interpolate);const o=h.snapshot.metadata.cameraMode,n=o===r.N3.Dollhouse||o===r.N3.Floorplan,c=(0,r.nI)(o),d=!this.viewmodeData.isInside()&&c,p=this.viewmodeData.isInside()&&n,m=!this.viewmodeData.isInside()&&n,g=this.viewmodeData.isInside()&&c;(d||p||m)&&(e=u.fl.Interpolate),void 0!==(null===(s=null==h?void 0:h.overrides)||void 0===s?void 0:s.transitionType)&&(e=h.overrides.transitionType),g&&0===t&&(e=u.fl.FadeToBlack),void 0!==i&&(e=i),this.engine.broadcast(new l.zb(t));const w=this.transitionFactory.getFloorTransition(t).start();if(this.data.useTransition(w),await w.promise,this.data.getTourState()===a.Ci.StopScheduled)return;const T=this.transitionFactory.getMainTransition(t,e).start();this.data.useTransition(T),await T.promise,this.data.setTourCurrentSnapshotByIndex(t),this.engine.broadcast(new l.n1(t))}if(this.data.getTourState()===a.Ci.StopScheduled)return;let g;this.toursViewData.getTourStoryMode()&&this.transitionFactory.isStaticFinalStop(t)&&(g=o.Dw),p>0&&(g=(1-p)*m);const w=this.transitionFactory.getBurnsTransition(t,e,g).start();this.engine.broadcast(new l.BW(t,w.type,w.duration)),this.data.useTransition(w),await w.promise}async stopTour({willResume:t=!1}={}){this.data.getTourState()===a.Ci.Active&&(this.data.setTourState(a.Ci.StopScheduled),this.data.tourWillResume=t,this.data.tourPlaying=!1,await this.data.stopTourTransition(),this.tourGenerator&&this.engine.stopGenerator(this.tourGenerator),this.engine.broadcast(new l.pT(t)),this.data.getTourCurrentSnapshotIndex()!==this.data.getHighlightsCount()-1||this.data.isLooping()||(this.data.tourEnded=!0,this.engine.broadcast(new l.YH)),this.data.setTourState(a.Ci.Inactive),this.data.commit())}async tourGoNext(t){let e=this.data.getTourCurrentSnapshotIndex()+1;return e>=this.data.getHighlightsCount()&&(e=0),this.tourGoTo(e,t)}async tourGoPrevious(t){let e=this.data.getTourCurrentSnapshotIndex();e<0&&(e=0);let i=e-1;return i<0&&(i=this.data.getHighlightsCount()-1),this.tourGoTo(i,t)}async tourGoTo(t,{transitionType:e=u.fl.FadeToBlack,instant:i,resumeIfPlaying:s=!1}={}){if(this.viewmodeData.transition&&this.viewmodeData.transition.active)throw new S.K("Cannot go to tour location during viewmode transition");const o=this.data.tourPlaying;o&&await this.stopTour({willResume:s});try{this.data.setTourState(a.Ci.Active),await this.composeTourTransition(t,y._y.None,i?u.fl.Instant:e)}catch(t){b.Ay.for(this).error(t)}finally{this.data.setTourState(a.Ci.Inactive)}s&&o&&this.startTour()}setupAutoPlay(t){const e=1e3*(0,o.dJ)(this.settingsData),i=()=>{let t=!0;const i=this.cameraData.pose.onChanged(()=>{t=!1,i.cancel()});setTimeout(()=>{t&&this.startTour(),i.cancel()},e)};if(e>=0){const e=t.market.tryGetData(g.zH);if(e&&e.phase===g.Jj.PLAYING)i();else{const e=s=>{s.phase===g.Jj.PLAYING&&(i(),t.unsubscribe(w.uv,e))};t.subscribe(w.uv,e)}}}}},52947:(t,e,i)=>{i.d(e,{Ay:()=>n,F7:()=>a,cF:()=>r});var s=i(68909);class o{constructor(t,e){this.raycast=(()=>{const t=new s.Vector3,e=new s.Box3;return(i,s,n,h)=>{const c=e.copy(this.bounds).expandByScalar(s);if(i.ray.intersectsBox(c))for(const e of this.children)if(e instanceof o)e.raycast(i,s,n,h);else if(e instanceof r){if(!1===(null==h?void 0:h(e)))continue;const o=t,r=i.ray.distanceSqToSegment(e.start,e.end,void 0,t),a=Math.sqrt(r);a<s&&n.push({distance:i.ray.origin.distanceTo(o),object:e,distanceToRay:a,point:o.clone(),isLineOctreeIntersection:!0})}else if(e instanceof a){if(!1===(null==h?void 0:h(e)))continue;const t=i.ray.distanceToPoint(e);t<s&&n.push({distance:i.ray.origin.distanceTo(e),object:e,distanceToRay:t,point:e.clone(),isLineOctreeIntersection:!0})}}})(),this.level=e,this.bounds=t.clone(),this.clear()}clear(){this.childNodes=[],this.children=[]}add(t){let e=!1;const i=t instanceof s.Line3?[t.start,t.end]:[t];if(this.level<4){0===this.childNodes.length&&this.buildChildNodes();for(const s of this.childNodes)i.every(t=>s.bounds.containsPoint(t))&&(e=!0,s.add(t))}e||this.children.push(t)}remove(t){const e=t instanceof s.Line3?[t.start,t.end]:[t];for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s instanceof o){if(e.every(t=>s.bounds.containsPoint(t))&&s.remove(t))return!0}else if(s===t)return this.children.splice(i,1),!0}return!1}buildChildNodes(){const t=this.bounds.max.clone().sub(this.bounds.min).clone().multiplyScalar(.5);for(let e=0;e<2;e++)for(let i=0;i<2;i++)for(let n=0;n<2;n++){const r=this.bounds.min.x+t.x*n,a=r+t.x,h=this.bounds.min.y+t.y*e,c=h+t.y,d=this.bounds.min.z+t.z*i,u=d+t.z,l=new s.Box3(new s.Vector3(r,h,d),new s.Vector3(a,c,u)),p=new o(l,this.level+1);this.childNodes.push(p),this.children.push(p)}}spherecast(t,e){if(t.intersectsBox(this.bounds))for(const i of this.children)if(i instanceof o)i.spherecast(t,e);else if(i instanceof r){const o=i.closestPointToPoint(t.center,!0,new s.Vector3);o.distanceTo(t.center)<t.radius&&e.push(new a(o))}else i instanceof s.Vector3&&i.distanceTo(t.center)<t.radius&&e.push(i)}traverse(t){for(const e of this.children)e instanceof o?e.traverse(t):t(e)}}class n{constructor(t){this.pointCount=0,this.lineCount=0,this.root=new o(t,0)}add(t){t instanceof s.Line3?this.lineCount++:t instanceof s.Vector3&&this.pointCount++,this.root.add(t)}remove(t){t instanceof r?this.lineCount--:t instanceof a&&this.pointCount--,this.root.remove(t)}clear(){this.root.clear(),this.pointCount=0,this.lineCount=0}traverse(t){this.root.traverse(t)}raycast(t,e,i){const s=[];return this.root.raycast(t,e,s,i),s}}class r extends s.Line3{constructor(t,e){super(t,e),this.start=t,this.end=e,this.isSnapLine3=!0}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}clone(){return new r(this.start,this.end)}}class a extends s.Vector3{constructor(t){super(),this.point=t,this.isSnapVector3=!0,super.copy(t)}copy(t){return this.point.copy(t.point),this}clone(){return new a(this.point)}}},23987:(t,e,i)=>{i.d(e,{Z:()=>s});const s=new class{constructor(t=!0){this.values=new Map,t&&this.show()}clear(){this.values.clear(),this.drawValues()}show(){if(this.debugDiv)return;this.debugDiv=document.createElement("div");const t=this.debugDiv.style;t.fontFamily="monospace",t.position="fixed",t.backgroundColor="#aa11aa",t.left="20px",t.top="20px",t.zIndex="999899",t.pointerEvents="none",t.touchAction="none",document.body.appendChild(this.debugDiv),this.drawValues()}hide(){this.debugDiv&&(document.body.removeChild(this.debugDiv),this.debugDiv=void 0)}logValue(t,e){this.values.set(t,e),this.drawValues()}logMaxValue(t,e){this.values.has(t)?e>this.values.get(t)&&this.logValue(t,e):this.logValue(t,e)}logVector2(t,e){this.logValue(t,`(${e.x}, ${e.y})`)}logVector3(t,e){this.logValue(t,`(${e.x}, ${e.y}, ${e.z})`)}logVector4(t,e){this.logValue(t,`(${e.x}, ${e.y}, ${e.z} ${e.w})`)}logPose(t,e){this.logVector3(t+"-pos",e.position),this.logVector4(t+"-rot",e.rotation),this.logValue(t+"-focalDist",e.focalDistance)}showPt(t){if(this.pointDiv)this.pointDiv.style.left=`${t.x}px`,this.pointDiv.style.top=`${t.y}px`;else{this.pointDiv=document.createElement("div");const e=this.pointDiv.style;e.position="fixed",e.width="8px",e.height="8px",e.backgroundColor="#aaffaa",e.left=t.x-4+"px",e.top=t.y-4+"px",e.zIndex="99999",e.pointerEvents="none",e.touchAction="none",document.body.appendChild(this.pointDiv)}}drawValues(){if(!this.debugDiv)return;let t="";for(const[e,i]of this.values.entries())t+=`${e}: ${i}<br>`;this.debugDiv.innerHTML=t}}}}]);