<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARK Safety Demo (WebComponent + Scene API)</title>

  <!-- Import map: must be before the Matterport script -->
<script type="importmap">
{
  "imports": {
    "three": "./three-shim.js",
    "https://unpkg.com/three@0.176.0/build/three.module.js?module": "./three-shim.js",
    "https://unpkg.com/three@0.176.0/build/three.module.js": "./three-shim.js"
  }
}
</script>

  <!-- Matterport WebComponent (ESM) -->
  <script type="module" src="https://unpkg.com/@matterport/webcomponent@0.1.45/dist/matterport-viewer.esm.js?module"></script>

  <style>
    html, body { height: 100%; margin: 0; background: #0b0f14; color: #e8edf2; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { display: flex; gap: .5rem; align-items: center; padding: .75rem 1rem; background: #11161d; border-bottom: 1px solid #1f2a37; }
    header .tag { font-weight: 600; opacity: .85; }
    header button { all: unset; background: #1f2a37; padding: .45rem .7rem; border-radius: .5rem; cursor: pointer; border: 1px solid #2b3949; }
    header button:hover { background:#243244; }
    header button:active { background:#1b2633; }
    header .spacer { flex: 1 1 auto; opacity:.6; font-size:.9rem; }
    .stage { position: relative; height: 100%; overflow: hidden; background: #000; }
    matterport-viewer { position: absolute; inset: 0; width: 100%; height: 100%; }
    #overlay { position: absolute; inset: 0; pointer-events: none; }
    .hud { position: absolute; left: 12px; bottom: 12px; background: rgba(9,12,17,.72); border: 1px solid rgba(64,86,110,.55); padding: .35rem .6rem; border-radius: .5rem; font-size: .85rem; user-select: none; }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <span class="tag">ARK</span>
      <button id="btnPlaceThreat">Place Threat</button>
      <button id="btnReset">Reset</button>
      <span class="spacer" id="status">Loading…</span>
    </header>

    <div class="stage">
      <matterport-viewer
        id="mpv"
        m="1ghABoaBFPZ"
        application-key="akqd0dp3hr9wz4eu70zd1rsab"
        asset-base="bundle"
        autoplay
        play>
      </matterport-viewer>

      <canvas id="overlay"></canvas>
      <div class="hud" id="hud">Idle</div>
    </div>
  </div>

  <script type="module">
    // ----------------------------
    // Config / UI helpers
    // ----------------------------
    const HARD_WIRE = ""; // e.g., "https://your-tunnel.trycloudflare.com"
    const BACKEND_URL = HARD_WIRE || window.location.origin;

    const hud = document.getElementById('hud');
    const statusEl = document.getElementById('status');
    const say = (msg) => { hud.textContent = msg; console.log('[ARK]', msg); };
    const status = (msg) => { statusEl.textContent = msg; };

    const overlay = document.getElementById('overlay');
    const ctx2d = overlay.getContext('2d');
    function sizeOverlay() {
      overlay.width = overlay.clientWidth;
      overlay.height = overlay.clientHeight;
      ctx2d.clearRect(0,0,overlay.width,overlay.height);
    }
    window.addEventListener('resize', sizeOverlay);

    const _ARK = { inScene: { available:false, THREE:null, root:null, routeMesh:null }, threat:null, lastRoute:null };

    function drawOverlayRoute(route) {
      ctx2d.clearRect(0,0,overlay.width,overlay.height);
      if (!route) return;
      ctx2d.beginPath();
      ctx2d.moveTo(20, overlay.height-20);
      ctx2d.lineTo(overlay.width-20, 20);
      ctx2d.lineWidth=4;
      ctx2d.strokeStyle="#21d38c";
      ctx2d.setLineDash([12,8]);
      ctx2d.stroke();
      ctx2d.setLineDash([]);
    }

    function resetRoute() {
      _ARK.lastRoute=null; _ARK.threat=null;
      ctx2d.clearRect(0,0,overlay.width,overlay.height);
      if (_ARK.inScene.available && _ARK.inScene.routeMesh && _ARK.inScene.root) {
        _ARK.inScene.root.remove(_ARK.inScene.routeMesh);
        _ARK.inScene.routeMesh=null;
      }
      say("Reset");
    }

    document.getElementById('btnReset').addEventListener('click', resetRoute);

    // ----------------------------
    // Place threat (demo logic)
    // ----------------------------
    document.getElementById('btnPlaceThreat').addEventListener('click', async () => {
      _ARK.threat = { placed:true };
      _ARK.lastRoute = { id:"demo" };
      drawOverlayRoute(_ARK.lastRoute);
      say("Threat placed (demo)");
      // Example POST:
      // await fetch(`${BACKEND_URL}/route/auto`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ /* ... */ }) })
      //   .then(r => r.json()).then(data => { /* render 3D line later */ });
    });

    // ----------------------------
    // Bootstrap
    // ----------------------------
    const viewer = document.getElementById('mpv');
    sizeOverlay();

    (async () => {
      await customElements.whenDefined('matterport-viewer');
      const mpSdk = await viewer.playingPromise;
      status("SDK connected (WebComponent)");

      const S = mpSdk.Scene;
      if (S && typeof S.register==='function') {
        // Helper that guarantees a plain, hasOwnProperty-capable object
        const toPlain = (o) => {
          if (!o || typeof o !== "object") return {};
          return Object.assign({}, o); // clone onto Object.prototype
        };

        class ArkRoute {
          constructor() {
            this.inputs  = {};
            this.outputs = {};
            this.events  = {};
            this.emits   = {};
            this.outputs.objectRoot = null;
          }
          onInit(ctx) {
            const T = ctx.THREE;
            const root = new T.Group();
            this.outputs.objectRoot = root; // property assign only

            _ARK.inScene = _ARK.inScene || {};
            _ARK.inScene.available = true;
            _ARK.inScene.THREE = T;
            _ARK.inScene.root = root;

            say("In-scene component initialized");
          }
          onTick() {}
          onDestroy() {
            _ARK.inScene.available = false;
            _ARK.inScene.root = null;
            _ARK.inScene.THREE = null;
            _ARK.inScene.routeMesh = null;
          }
        }

        // Register with normalization BEFORE the SDK wraps it
        await S.register("arkRoute", () => {
          const c = new ArkRoute();
          c.inputs  = toPlain(c.inputs);
          c.outputs = toPlain(c.outputs);
          c.events  = toPlain(c.events);
          c.emits   = toPlain(c.emits);
          return c;
        });

        // Create node and attach our component safely
        const node = await S.createNode();

        // Keep lights commented until we confirm no crashes
        // try { node.addComponent("mp.lights", {}); } catch {}

        // Guaranteed-plain options object (and guard)
        const arkOpts = toPlain({});
        console.log("[ARK] addComponent about to run. typeof arkOpts:", typeof arkOpts,
                    "proto is Object.prototype:", Object.getPrototypeOf(arkOpts) === Object.prototype);

        if (!arkOpts || typeof arkOpts !== "object") {
          throw new Error("[ARK] Refusing to call addComponent: options is not an object");
        }
        if (typeof arkOpts.hasOwnProperty !== "function") {
          Object.setPrototypeOf(arkOpts, Object.prototype);
          console.warn("[ARK] options lacked hasOwnProperty; repaired prototype.");
        }

        node.addComponent("arkRoute", arkOpts);
        await node.start();
      } else {
        console.warn("[ARK] Scene API not available; overlay fallback.");
      }

      // Keep 2D overlay in sync if we’re not using in-scene rendering
      try {
        mpSdk.Camera.pose.subscribe(() => {
          if (_ARK.lastRoute && !_ARK.inScene.available) drawOverlayRoute(_ARK.lastRoute);
        });
      } catch(err) {
        console.warn("[ARK] pose.subscribe failed", err);
      }

    })().catch(err => { console.warn("[ARK] bootstrap failed:", err); });
  </script>
</body>
</html>