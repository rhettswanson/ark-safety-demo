<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ark Safety Demo – Matterport</title>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; }
    body { background:#111; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#e5e7eb; }
    #wrap { position: relative; height: 100%; width: 100%; overflow: hidden; }
    iframe#mp { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; background:#000; }

    #hud {
      position: absolute; top: 10px; left: 10px; z-index: 20;
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      background: rgba(0,0,0,.6); padding: 10px; border-radius: 10px; backdrop-filter: blur(4px);
    }
    .btn { appearance: none; border: 0; padding: 6px 10px; border-radius: 8px; cursor: pointer; background:#222; color:#eee; font-weight: 600; }
    .btn:hover { background:#2f2f2f; }
    .switch { display:inline-flex; align-items:center; gap:6px; }
    .switch input { transform: translateY(1px); }

    #loading { position: absolute; inset: 0; z-index: 19; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.65) 0%, rgba(0,0,0,.85) 60%); }
    .spinner { width: 86px; height: 86px; border-radius: 50%; border: 8px solid rgba(255,255,255,.2); border-top-color: #fff; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #ai-overlay { position:absolute; inset:0; pointer-events:none; z-index:21; font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #srcBadge { position:absolute; left:12px; bottom:12px; z-index: 22; padding:4px 8px; border-radius:12px; background:#1f2937; color:#fff; opacity:.85; font:12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  </style>
</head>
<body>
  <div id="wrap">
    <iframe id="mp" allow="fullscreen; xr-spatial-tracking" allowfullscreen src=""></iframe>

    <div id="hud" role="toolbar" aria-label="Controls">
      <button class="btn" id="btnDollhouse">Dollhouse start</button>
      <button class="btn" id="btnInside">Inside start</button>

      <label class="switch"><input type="checkbox" id="chkBrand" checked /><span>Hide branding</span></label>
      <label class="switch"><input type="checkbox" id="chkQuiet"  checked /><span>Quiet UI</span></label>
      <label class="switch"><input type="checkbox" id="chkAutoplay" checked /><span>Autoplay</span></label>

      <button class="btn" id="btnApply">Apply</button>
      <button class="btn" id="btnFullscreen">Fullscreen</button>

      <button class="btn" id="btnAnalyze" title="Hotkey: A">Analyze (AI)</button>
    </div>

    <div id="loading"><div class="spinner" aria-label="Loading"></div></div>
    <div id="ai-overlay" aria-hidden="true"></div>
    <div id="srcBadge">Source: Local</div>
  </div>

  <script>
    /********* CONFIG *********/
    const MODEL  = "1ghABoaBFPZ";
    const APPKEY = "akqd0dp3hr9wz4eu70zd1rsab";
    const BACKEND_URL = "https://assuming-troubleshooting-path-knitting.trycloudflare.com"; // update if your tunnel changes
    const BUNDLE_PATH = "bundle/dist/showcase.html";

    const mp  = document.getElementById("mp");
    const wrap = document.getElementById("wrap");
    const overlay = document.getElementById("ai-overlay");

    const btnD = document.getElementById("btnDollhouse");
    const btnI = document.getElementById("btnInside");
    const btnApply = document.getElementById("btnApply");
    const btnFS = document.getElementById("btnFullscreen");
    const btnAnalyze = document.getElementById("btnAnalyze");

    const chkBrand = document.getElementById("chkBrand");
    const chkQuiet = document.getElementById("chkQuiet");
    const chkAuto  = document.getElementById("chkAutoplay");

    const info= console.info.bind(console, "[app]");
    const warn= console.warn.bind(console, "[app]");

    const $loading = document.getElementById("loading");
    function setLoading(on){ if($loading) $loading.style.display = on ? "flex" : "none"; }
    function setSourceBadge(text){ const b=document.getElementById("srcBadge"); if(b) b.textContent=`Source: ${text}`; }

    function buildShowcaseUrl(start="") {
      const brand = chkBrand.checked ? 0 : 1;
      const quiet = chkQuiet.checked ? 1 : 0;
      const play  = chkAuto.checked  ? 1 : 0;
      const base = `${BUNDLE_PATH}?m=${encodeURIComponent(MODEL)}&applicationKey=${encodeURIComponent(APPKEY)}&brand=${brand}&qs=${quiet}&play=${play}&q=18`;
      return start ? `${base}&start=${encodeURIComponent(start)}` : base;
    }

    async function connectShowcase(timeoutMs=15000){
      const t0=performance.now();
      while(performance.now()-t0<timeoutMs){
        try{
          const w=mp.contentWindow;
          if(w?.MP_SDK?.connect){
            const sdk=await w.MP_SDK.connect(w, APPKEY);
            window._mpSdk=sdk;
            info("SDK connected");
            setLoading(false);
            return sdk;
          }
        }catch(e){}
        await new Promise(r=>setTimeout(r,200));
      }
      throw new Error("Timed out waiting for MP_SDK.connect");
    }

    function initialLoad(){ setLoading(true); setSourceBadge("Local"); mp.src=buildShowcaseUrl(""); afterIframeSrcSet(); }
    async function afterIframeSrcSet(){ try{ await connectShowcase(15000); }catch(e){ warn("MP_SDK connect failed:", e.message); } }

    btnD.addEventListener("click",()=>{ mp.src=buildShowcaseUrl("dollhouse"); afterIframeSrcSet(); });
    btnI.addEventListener("click",()=>{ mp.src=buildShowcaseUrl("inside");    afterIframeSrcSet(); });
    btnApply.addEventListener("click",()=>{ mp.src=buildShowcaseUrl("");      afterIframeSrcSet(); });
    btnFS.addEventListener("click",async()=>{ try{ await (wrap.requestFullscreen?.()||wrap.webkitRequestFullscreen?.()); }catch(_){} });

    window.addEventListener("keydown",(ev)=>{ if(ev.key.toLowerCase()==="a"){ ev.preventDefault(); btnAnalyze.click(); } });

    /* ===== Screenshot capture with robust fallbacks ===== */
    async function blobToDataURL(blob){
      return await new Promise(res => { const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); });
    }

    async function getIframeSnapshotDataUrl() {
      try {
        const iframe = document.getElementById("mp");
        const url = new URL(iframe.src);
        url.searchParams.set("screenshot", "1");
        url.searchParams.set("w", "1280");
        const resp = await fetch(url.toString(), { mode: "cors" });
        if (!resp.ok) throw new Error("snapshot fetch failed");
        const blob = await resp.blob();
        if (!blob.type.startsWith("image/")) throw new Error("not an image");
        return await blobToDataURL(blob);
      } catch (e) {
        console.warn("Iframe snapshot fallback failed:", e?.message || e);
        return null;
      }
    }

    async function getScreenshotDataUrl(sdk) {
      const tryConvert = async (out) => {
        if (!out) return null;
        if (out instanceof Blob) return await blobToDataURL(out);
        if (typeof out === "string" && out.startsWith("data:image")) return out;
        if (out instanceof Uint8Array) return await blobToDataURL(new Blob([out], { type: "image/jpeg" }));
        if (out instanceof ArrayBuffer) return await blobToDataURL(new Blob([new Uint8Array(out)], { type: "image/jpeg" }));
        return null;
      };

      try {
        // 1) Renderer API (try all known signatures)
        if (sdk?.Renderer?.takeScreenShot) {
          try {
            const out = await sdk.Renderer.takeScreenShot({ resolution: { width: 1280, height: 720 } });
            const url = await tryConvert(out); if (url) return url;
          } catch (e) { console.warn("Renderer.takeScreenShot object-style failed:", e?.message || e); }

          try {
            const out = await sdk.Renderer.takeScreenShot(1280, 720);
            const url = await tryConvert(out); if (url) return url;
          } catch (e) { console.warn("Renderer.takeScreenShot tuple-style failed:", e?.message || e); }

          try {
            const out = await sdk.Renderer.takeScreenShot({ width: 1280, height: 720 });
            const url = await tryConvert(out); if (url) return url;
          } catch (e) { console.warn("Renderer.takeScreenShot simple-options failed:", e?.message || e); }
        }

        // 2) Scene API (v5+ often Blob)
        if (sdk?.Scene?.captureScreenshot) {
          try {
            const out = await sdk.Scene.captureScreenshot({ width: 1280, height: 720 });
            const url = await tryConvert(out); if (url) return url;
          } catch (e) { console.warn("Scene.captureScreenshot failed:", e?.message || e); }
        }

        // 3) Camera API (older builds)
        if (sdk?.Camera?.takeScreenShot) {
          try {
            const out = await sdk.Camera.takeScreenShot(1280, 720);
            const url = await tryConvert(out); if (url) return url;
          } catch (e) { console.warn("Camera.takeScreenShot tuple-style failed:", e?.message || e); }

          try {
            const out = await sdk.Camera.takeScreenShot({ width: 1280, height: 720 });
            const url = await tryConvert(out); if (url) return url;
          } catch (e) { console.warn("Camera.takeScreenShot object-style failed:", e?.message || e); }
        }
      } catch (e) {
        console.warn("Screenshot capture threw:", e?.message || e);
      }

      console.warn("Screenshot capture failed (no usable output) — using iframe snapshot");
      return await getIframeSnapshotDataUrl();
    }

    function clearOverlay(){ overlay.innerHTML=""; }
    function renderBoxes(out){
      clearOverlay();
      const W=wrap.clientWidth, H=wrap.clientHeight;
      const imgW=out.imageWidth||1280, imgH=out.imageHeight||720;
      const sx=W/imgW, sy=H/imgH;
      (out.boxes||[]).forEach(b=>{
        const el=document.createElement("div");
        el.style.position="absolute";
        el.style.left=(b.x*sx)+"px"; el.style.top=(b.y*sy)+"px";
        el.style.width=(b.w*sx)+"px"; el.style.height=(b.h*sy)+"px";
        el.style.border="2px solid #00ff88"; el.style.borderRadius="4px"; el.style.boxShadow="0 0 6px rgba(0,255,136,.6)";
        overlay.appendChild(el);
        const tag=document.createElement("div");
        tag.textContent=`${b.label ?? "obj"} ${Math.round((b.score ?? 0)*100)}%`;
        tag.style.position="absolute";
        tag.style.left=(b.x*sx)+"px"; tag.style.top=(b.y*sy-20)+"px";
        tag.style.padding="2px 6px"; tag.style.font="12px/18px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif";
        tag.style.background="rgba(0,0,0,.7)"; tag.style.color="#00ff88"; tag.style.border="1px solid #00ff88"; tag.style.borderRadius="4px";
        overlay.appendChild(tag);
      });
    }

    async function analyze(){
      btnAnalyze.disabled=true; btnAnalyze.textContent="Analyzing…"; setLoading(true);
      try{
        const sdk = window._mpSdk || await connectShowcase(12000);
        const dataUrl = await getScreenshotDataUrl(sdk); // may be null (but we try hard not to)
        let pose=null; try{ pose = await sdk.Camera?.getPose?.(); }catch(_){}
        const payload={ spaceId: MODEL, image: dataUrl, pose };

        const res = await fetch(`${BACKEND_URL}/infer`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });
        if(!res.ok) throw new Error(`Backend ${res.status}`);
        const out = await res.json();
        renderBoxes(out || {});
      }catch(e){
        clearOverlay(); console.warn("[app] Analyze failed:", e.message); alert("Analyze failed: "+e.message);
      }finally{
        setLoading(false); btnAnalyze.disabled=false; btnAnalyze.textContent="Analyze (AI)";
      }
    }

    // Kick it off
    initialLoad();
    document.getElementById("btnAnalyze").addEventListener("click", analyze);
  </script>
</body>
</html>