<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ark SafeRoute — Phase 1.2 (WebComponent)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0f1a; color:#e5e7eb;}
    .topbar{position:fixed; inset:0 0 auto 0; display:flex; gap:16px; align-items:center; padding:10px 12px; background:rgba(10,14,25,.85); backdrop-filter: blur(6px); border-bottom:1px solid #1f2937; z-index:10}
    .pill{background:#111827; border:1px solid #374151; color:#9ca3af; border-radius:999px; padding:4px 10px; font-size:12px}
    .group{display:flex; align-items:center; gap:10px}
    .btn{cursor:pointer; background:#0f172a; color:#e5e7eb; border:1px solid #1f2937; border-radius:8px; padding:8px 12px; font-weight:600}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .field{display:flex; align-items:center; gap:6px}
    #stats{margin-left:auto; color:#9ca3af; font-size:13px}
    #stage{position:absolute; inset:48px 0 0 0; background:#000}
    #overlay{position:absolute; inset:48px 0 0 0; pointer-events:none}
    #toast{position:fixed; right:12px; bottom:12px; background:#111827; border:1px solid #374151; color:#e5e7eb; padding:8px 12px; border-radius:8px; font-size:13px; opacity:0; transform:translateY(6px); transition:all .25s}
    #toast.show{opacity:1; transform:translateY(0)}
  </style>

  <!-- Load the Matterport WebComponent (CDN). It will fetch static assets from asset-base="bundle". -->
  <script type="module">
    import 'https://unpkg.com/@matterport/webcomponent?module';
  </script>
</head>
<body>
  <div class="topbar">
    <span class="pill">Phase 1.2</span>
    <div class="group">
      <button class="btn" id="btnPlaceThreat">Place Threat</button>
      <div class="field">
        <label>Mode</label>
        <select id="modeSelect" class="btn" style="padding:6px 10px; background:#0f172a;">
          <option value="auto" selected>Auto (Recommended)</option>
          <option value="evac">Force Evac</option>
          <option value="shelter">Force Shelter</option>
        </select>
      </div>
      <button class="btn" id="btnReset">Reset</button>
    </div>
    <div id="stats">Loading…</div>
  </div>

  <div id="stage">
    <!-- ✅ Use attribute form + asset-base so CSS/fonts load from /ark-safety-demo/bundle/... -->
    <matterport-viewer
      id="mp"
      style="width:100%;height:100%;border:0;display:block"
      m="1ghABoaBFPZ"
      application-key="akqd0dp3hr9wz4eu70zd1rsab"
      asset-base="bundle"
      autoplay
      qs
      play>
    </matterport-viewer>
  </div>

  <!-- Overlay canvas (labels + fallback) -->
  <canvas id="overlay"></canvas>
  <div id="toast"></div>

  <script type="module">
    // Tunnel in prod; localhost when running file server locally
    const BACKEND_URL = (() => {
      return location.hostname.endsWith('github.io')
        ? 'https://potter-democratic-networking-involves.trycloudflare.com'
        : 'http://localhost:7860';
    })();

    const stats = document.getElementById('stats');
    const toastEl = document.getElementById('toast');
    function info(msg){ console.log('[ARK]', msg); stats.textContent = msg; }
    let toastTimer;
    function toast(msg, ms=2200){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    function sizeOverlay(){ overlay.width=overlay.clientWidth; overlay.height=overlay.clientHeight; }
    function clearCanvas(){ ctx.clearRect(0,0,overlay.width, overlay.height); }
    function drawRoute(route){
      clearCanvas(); if (!route||route.length<2) return;
      ctx.lineJoin="round"; ctx.lineCap="round";
      // glow
      ctx.lineWidth=14; ctx.strokeStyle="rgba(0,200,130,0.25)";
      ctx.beginPath(); route.forEach(([x,y],i)=>{const [px,py]=[overlay.width/2+x*10,overlay.height/2-y*10]; i?ctx.lineTo(px,py):ctx.moveTo(px,py);}); ctx.stroke();
      // core animated path
      ctx.setLineDash([18,10]); ctx.lineDashOffset=-(performance.now()*0.05);
      ctx.lineWidth=7; ctx.strokeStyle="#00C882";
      ctx.beginPath(); route.forEach(([x,y],i)=>{const [px,py]=[overlay.width/2+x*10,overlay.height/2-y*10]; i?ctx.lineTo(px,py):ctx.moveTo(px,py);}); ctx.stroke(); ctx.setLineDash([]);
    }

    // In-scene helpers
    window._ARK = { inScene:{ available:false, scene:null, THREE:null, routeMesh:null }};
    function routeMeshFromPolyline(poly, floorY=0.1){
      const T=_ARK.inScene.THREE; if(!T||!poly||poly.length<2)return null;
      const pts=poly.map(([x,y])=>new T.Vector3(x,floorY,y));
      const curve=new T.CatmullRomCurve3(pts,false,'catmullrom',0.02);
      const geom=new T.TubeGeometry(curve,Math.max(40,pts.length*10),0.12,8,false);
      const mat=new T.MeshStandardMaterial({color:0x00c882,roughness:0.6,metalness:0});
      mat.emissive=new T.Color(0x00c882); mat.emissiveIntensity=0.35;
      return new T.Mesh(geom,mat);
    }
    function renderRoute(poly){
      if(_ARK.inScene.available){
        if(_ARK.inScene.routeMesh){_ARK.inScene.scene.remove(_ARK.inScene.routeMesh);}
        const mesh=routeMeshFromPolyline(poly,0.1);
        if(mesh){_ARK.inScene.scene.add(mesh);_ARK.inScene.routeMesh=mesh; clearCanvas(); return;}
      }
      drawRoute(poly);
    }
    function resetRoute(){
      if(_ARK.inScene.routeMesh&&_ARK.inScene.scene){_ARK.inScene.scene.remove(_ARK.inScene.routeMesh);}
      _ARK.inScene.routeMesh=null; clearCanvas(); window._lastRoute=null;
    }

    let _sdk=null; let threat=null;
    async function isGroundable(){
      try{const rect=overlay.getBoundingClientRect();const hit=await _sdk.Renderer.getWorldPositionData({x:rect.width/2,y:rect.height/2});return !!(hit&&hit.normal&&hit.normal.y>0.7);}catch{return false;}
    }
    async function routeSafeAuto(){
      if(!await isGroundable()){toast("Move inside first");return;}
      if(!threat){toast("Place a threat");return;}
      const pos=await _sdk.Camera.getPosition(); const cam={x:pos.x,y:pos.z};
      const mode=(document.getElementById("modeSelect")?.value||"auto").toLowerCase();
      const url = mode==="auto" ? `${BACKEND_URL}/route/auto` : `${BACKEND_URL}/route_safe`;
      const body= mode==="auto" ? {start:cam,threat} : {start:cam,threat,prefer:mode==="evac"?"exit":"shelter"};
      const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
      if(!res.ok){ toast(`Route error ${res.status}`); return; }
      const out=await res.json();
      window._lastRoute=out.route;
      stats.textContent=`Length: ${out.length_m?.toFixed(1)} m · ${out.mode_selected||out.decision||"—"}`;
      renderRoute(out.route);
    }
    function enableThreatPlacement(){
      toast("Click in scene to place threat");
      window.addEventListener('click', onClickOnce,{once:true});
      async function onClickOnce(ev){
        const hit=await _sdk.Renderer.getWorldPositionData({x:ev.clientX,y:ev.clientY});
        if(hit?.position&&hit.normal?.y>0.4){threat={x:hit.position.x,y:hit.position.z};toast("Threat placed");routeSafeAuto();}
        else toast("Not a floor hit");
      }
    }
    document.getElementById('btnPlaceThreat').addEventListener('click', enableThreatPlacement);
    document.getElementById('btnReset').addEventListener('click', resetRoute);

    // Boot: listen for mpSdkPlaying
    customElements.whenDefined('matterport-viewer').then(()=>{
      const el=document.getElementById('mp');
      el.addEventListener('mpSdkPlaying', async (e)=>{
        _sdk=e.detail.mpSdk; info("SDK connected (WebComponent)");

        // ✅ Guard: only use Scene API if this build exposes it
        const S = _sdk.Scene;
        if (S && typeof S.register === 'function' && typeof S.create === 'function') {
          class ArkRoute {
            onInit(ctx){
              _ARK.inScene.available=true;
              _ARK.inScene.scene=ctx.scene;
              _ARK.inScene.THREE=ctx.THREE;
              console.log("[ARK] In-scene enabled via IComponentContext");
            }
            onTick() {}
            onDestroy() {}
          }
          S.register('arkRoute', ArkRoute);
          await S.create('arkRoute');
        } else {
          console.warn('[ARK] Scene API not available; overlay fallback in use.');
          _ARK.inScene.available=false;
        }

        // Keep overlay “glued” when we’re using it
        try{ _sdk.Camera.pose.subscribe(()=>{ if (window._lastRoute) drawRoute(window._lastRoute); }); }catch{}
      },{once:true});
    });

    sizeOverlay();
  </script>
</body>
</html>